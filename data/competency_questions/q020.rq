# category: "Works and Expressions"
# split: "hard"
# origin: competency_question
# question: "Give me a cycle of melodies whose author of text is the same for each melody"
# query:
SELECT DISTINCT ?expression (SAMPLE(?title) AS ?title) (SAMPLE(?authorName) AS ?author)
WHERE {
  ?expression a efrbroo:F22_Self-Contained_Expression ;
              rdfs:label ?title ;
              mus:U12_has_genre <http://data.doremus.org/vocabulary/iaml/genre/mld> ;
              efrbroo:R5_has_component ?single .

  ?creationActivity efrbroo:R17_created ?single ;
                    ecrm:P9_consists_of ?subActivity .

  ?subActivity ecrm:P14_carried_out_by ?author ;
               mus:U31_had_function <http://data.doremus.org/vocabulary/function/author> .

  ?author foaf:name ?authorName .
}
GROUP BY ?expression
HAVING (COUNT(DISTINCT ?author) = 1)

# workflow
build_query(question="Give me a cycle of melodies whose author of text is the same for each melody", template="expression")
apply_filter(query_id=query_id, base_variable="expression", template="expression", filters={"genre": "melody"})
add_triplet(subject="expression", subject_class="efrbroo:F22_Self-Contained_Expression", property="efrbroo:R5_has_component", obj="single", obj_class="efrbroo:F22_Self-Contained_Expression", query_id=query_id)
add_triplet(subject="creation", subject_class="efrbroo:F28_Expression_Creation", property="efrbroo:R17_created", obj="single", obj_class="efrbroo:F22_Self-Contained_Expression", query_id=query_id)
add_triplet(subject="creation", subject_class="efrbroo:F28_Expression_Creation", property="ecrm:P9_consists_of", obj="subActivity", obj_class="ecrm:E7_Activity", query_id=query_id)
add_triplet(subject="subActivity", subject_class="ecrm:E7_Activity", property="ecrm:P14_carried_out_by", obj="author", obj_class="ecrm:E21_Person", query_id=query_id)
groupBy_having(subject="expression", obj="author", function="COUNT", logic_type="equal", valueStart="1", query_id=query_id)
execute_query(query_id=query_id)