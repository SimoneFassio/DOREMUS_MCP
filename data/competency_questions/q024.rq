# category: "Works and Expressions"
# split: "hard"
# origin: competency_question
# question: "Give me all works for piano based on works of Schubert"
# query:
SELECT ?work AS ?original (SAMPLE(?title) AS ?original_title) ?work2 AS ?derived (SAMPLE(?title2) AS ?derived_title)
WHERE {
  ?expression a efrbroo:F22_Self-Contained_Expression ;
              rdfs:label ?title ;
              mus:U13_has_casting ?casting .

  ?expCreation efrbroo:R17_created ?expression ;
               ecrm:P9_consists_of ?activity .
  ?activity ecrm:P14_carried_out_by <http://data.doremus.org/artist/03954109-0253-35d6-a70e-89ab27dea09c> .

  ?work efrbroo:R9_is_realised_in ?expression ;
        a efrbroo:F14_Individual_Work ;
        efrbroo:R2_is_derivative_of ?work2 .
  ?work2 a efrbroo:F14_Individual_Work ;
         efrbroo:R9_is_realised_in ?expression2 .
  ?expression2 rdfs:label ?title2 .

  ?casting mus:U23_has_casting_detail ?cDet .
  ?cDet mus:U2_foresees_use_of_medium_of_performance / skos:exactMatch* <http://data.doremus.org/vocabulary/iaml/mop/kpf> .
}
GROUP BY ?work ?work2 ?casting ?expression
HAVING (COUNT(DISTINCT ?cDet) = 1)

# workflow
build_query(question="Give me all works for piano based on works of Schubert", template="expression")
add_component_constraint(subject="expression", obj="piano", query_id=query_id)
add_triplet(subject="expression", subject_class="efrbroo:F22_Self-Contained_Expression", property="^efrbroo:R9_is_realised_in", obj="work", obj_class="efrbroo:F14_Individual_Work", query_id=query_id)
add_triplet(subject="work", subject_class="efrbroo:F14_Individual_Work", property="efrbroo:R2_is_derivative_of", obj="work2", obj_class="efrbroo:F14_Individual_Work", query_id=query_id)
add_triplet(subject="work2", subject_class="efrbroo:F14_Individual_Work", property="efrbroo:R9_is_realised_in", obj="expression2", obj_class="efrbroo:F22_Self-Contained_Expression", query_id=query_id)
add_triplet(subject="expression2", subject_class="efrbroo:F22_Self-Contained_Expression", property="efrbroo:R17_created", obj="expCreation2", obj_class="efrbroo:F28_Expression_Creation", query_id=query_id)
add_triplet(subject="expCreation2", subject_class="efrbroo:F28_Expression_Creation", property="ecrm:P9_consists_of", obj="activity2", obj_class="ecrm:E7_Activity", query_id=query_id)
add_triplet(subject="activity2", subject_class="ecrm:E7_Activity", property="ecrm:P14_carried_out_by", obj="schubert", obj_class="ecrm:E21_Person", query_id=query_id)
# Manually add filter/binding for Schubert URI
execute_query(query_id=query_id)